# IDLE-Web Architecture Overview

> **Generated by**: codebase-cartographer
> **Last Updated**: 2026-01-29
> **Scope**: Complete Angular 18 application structure for IDLE idle/incremental space colonization game
> **Status**: MVP v0.2.0 in development

## Summary

IDLE-Web is an Angular 18 application using signals for reactive state management, implementing a complex idle/incremental game about discovering and colonizing star systems. The architecture follows NgModule pattern with service-based business logic and signal-based state management. Game features include exploration, colonization, resource production, population management, trade routes, and supply transport missions.

## File Structure

```
src/app/
├── components/
│   ├── system-view/              # Display current system details and management UI
│   ├── galaxy-view/              # Galaxy map and system selection
│   ├── fleet-view/               # Ship fleet status and mission management
│   └── market-view/              # Galactic market buy/sell interface
├── models/
│   ├── resource.model.ts         # ResourceId enum, ResourceDefinition, ResourceStock
│   ├── facility.model.ts         # FacilityId enum, FacilityDefinition, production configs
│   ├── celestial-body.model.ts   # BodyType enum, BodyFeature, orbital structure
│   ├── star-system.model.ts      # SystemRarity, SystemState, navigation data
│   ├── ship.model.ts             # Ship types, sizes, tiers, missions, trade routes
│   ├── game-state.model.ts       # GameState, GameSettings, Notifications, Stats
│   ├── prestige.model.ts         # PrestigeState for New Game+ system
│   ├── transport-mission.model.ts # Supply transport mission types (NEW - GDD v6)
│   └── index.ts                  # Barrel export
├── services/
│   ├── game-state.service.ts     # Central state management with signals
│   ├── game-loop.service.ts      # Game tick handler, offline calculation
│   ├── galaxy-generator.service.ts # Procedural star system generation
│   ├── home-system.service.ts    # Home system (Sol) initialization
│   ├── exploration.service.ts    # Scout missions, discovery mechanics
│   ├── colonization.service.ts   # Colonization missions, colony ship mechanics
│   ├── construction.service.ts   # Facility construction, cost calculation
│   ├── production.service.ts     # Resource extraction/conversion, tier-order processing
│   ├── population.service.ts     # Population growth, pull factors, SoL
│   ├── trade.service.ts          # Trade routes, galactic market, ship logistics
│   ├── supply-transport.service.ts # Supply transport system (NEW - GDD v6)
│   ├── prestige.service.ts       # Prestige/reset mechanics
│   ├── stellar-forge.ts          # Ship construction and upgrades
│   └── index.ts                  # Barrel export
├── config/
│   └── testing.config.ts         # Hardcoded values marked //TESTING for easier iteration
├── app.module.ts                 # NgModule declarations, imports, providers
├── app-routing.module.ts         # Router configuration
├── app.component.ts              # Root component
└── app.component.html            # Root template
```

## Core Architecture Patterns

### 1. Signal-Based State Management (Angular 18)

```typescript
// GameStateService example:
private _gameState = signal<GameState>(initialState);  // Mutable state
readonly credits = computed(() => this._gameState().credits);  // Derived state
readonly selectedSystem = computed(() => {  // Composite derived state
  const systemId = this.selectedSystemId();
  return systemId ? this.systems()[systemId] : null;
});

// State updates always immutable
this._gameState.update(state => ({
  ...state,
  credits: state.credits + amount
}));
```

### 2. Model/Definition Pattern

All major game entities follow this pattern:

```typescript
// 1. Export enum for IDs (O(1) lookup keys)
export enum ResourceId { ... }

// 2. Export interface for definitions
export interface ResourceDefinition { ... }

// 3. Export constant record for lookups
export const RESOURCE_DEFINITIONS: Record<ResourceId, ResourceDefinition> = { ... }
```

### 3. Service Injection with inject()

```typescript
@Injectable({ providedIn: 'root' })
export class MyService implements OnDestroy {
  private gameState = inject(GameStateService);
  private http = inject(HttpClient);

  ngOnDestroy(): void {
    // Cleanup subscriptions, intervals
  }
}
```

### 4. Immutable Updates Pattern

All state updates in services spread existing state:

```typescript
// ✓ Correct
this._gameState.update(state => ({
  ...state,
  credits: state.credits - cost
}));

// ✓ Correct - nested updates
this._gameState.update(state => ({
  ...state,
  systems: {
    ...state.systems,
    [systemId]: { ...state.systems[systemId], colonized: true }
  }
}));
```

### 5. Boolean Return + Notification Pattern

Service methods return boolean success/failure and use notifications for feedback:

```typescript
launchMission(shipId: string): boolean {
  const ship = this.gameState.ships()[shipId];

  if (!ship) {
    this.gameState.addNotification({
      type: 'warning',
      title: 'Invalid Ship',
      message: 'Ship not found.'
    });
    return false;
  }

  // ... perform action ...

  this.gameState.addNotification({
    type: 'success',
    title: 'Mission Launched',
    message: `${ship.name} is now en route.`
  });
  return true;
}
```

### 6. Time Handling Conventions

- **Timestamps**: Always `Date.now()` (milliseconds since epoch)
- **Duration calculations**: Convert to hours: `ms / (1000 * 60 * 60)`
- **Game loop**: Passes `deltaTime` in milliseconds

```typescript
const offlineMs = now - lastSaveTime;
const offlineHours = offlineMs / (1000 * 60 * 60);
```

### 7. Production Tier Processing Order

Facilities processed in tier order: Extraction (T1) → Refining (T2) → Processing (T3) → Advanced (T4) → High-Tech (T5)

```typescript
const sortedFacilities = facilities.sort((a, b) => a.tier - b.tier);
for (const facility of sortedFacilities) {
  if (facility.tier === 1) {
    // Extraction: add to storage
  } else {
    // Conversion: check inputs first, then consume and produce
  }
}
```

## Service API Architecture

### GameStateService (Central Hub)

**Role**: Single source of truth for all game state. All entity reads/writes go through here.

**Key Methods**:
- `getState(): GameState` - Full state snapshot
- `updateSystem(systemId, updates)` - Update system properties
- `getSystem(systemId)` - Retrieve system by ID
- `addSystem(system)` - Add new system
- `updateBody(bodyId, updates)` - Update celestial body
- `addNotification(notification)` - Queue player notification
- `setSelectedSystem(systemId)` - UI selection state

**Key Signals**:
- `credits`, `systems`, `bodies`, `facilities`, `ships`
- `selectedSystemId`, `selectedBodyId`
- `discoveredSystems`, `colonizedSystems`, `idleShips`

### GameLoopService (Tick Handler)

**Role**: Drives game progression via regular ticks, calculates offline time, triggers production/population updates.

**Key Methods**:
- `startGameLoop()` - Begin ticking
- `tick(deltaMs)` - Process single game tick
- `calculateOfflineTime()` - Batch process offline progression

### ExplorationService (Scout Missions)

**Role**: Scout discovery, system survey, frontier management.

**Key Methods**:
- `launchScoutMission(shipId)` - Send scout to frontier
- `completeMission(missionId)` - Receive survey results

### ColonizationService (Colonization System)

**Role**: Colonization missions, colony ship mechanics, trade outpost establishment.

**Key Methods**:
- `startColonization(shipId, systemId, bodyId)` - Begin colonization mission
- `deliverToColony(shipId, missionId)` - Shuttle cargo to colony ship
- `completeColonization(missionId)` - Convert colony ship to trade outpost

### ConstructionService (Building Mechanics)

**Role**: Facility construction, cost calculation, construction validation.

**Key Methods**:
- `canBuild(facilityId, bodyId)` - Check prerequisites
- `buildFacility(facilityId, bodyId)` - Start construction
- `calculateConstructionCost(facilityId, bodyId)` - Distance/count scaling

### ProductionService (Resource Generation)

**Role**: Extraction, conversion, tier-order processing, storage management.

**Key Methods**:
- `processProduction(deltaHours)` - Tick production for all facilities
- `processExtraction(facility)` - T1 extraction
- `processConversion(facility)` - T2+ conversion with input checking

### PopulationService (Population Dynamics)

**Role**: Population growth, pull factor calculation, standard of living.

**Key Methods**:
- `calculatePopulationGrowth(systemId, deltaHours)` - Compute growth/decline
- `calculatePullFactors(systemId)` - Aggregate all pull factors
- `hasEnoughFood(systemId)` - Check consumption vs production

### TradeService (Trade Routes & Market)

**Role**: Trade route management, galactic market, one-time missions, logistics.

**Key Methods**:
- `setupTradeRoute(shipId, destination, config)` - Create recurring route
- `cancelRoute(routeId)` - Stop route
- `buyFromMarket(resourceId, amount)` - Purchase at market
- `sellToMarket(resourceId, amount)` - Sell to market

### SupplyTransportService (NEW - GDD v6 Section 15)

**Role**: One-way missions, round-trip missions, recurring transport routes.

**Key Methods**:
- `launchOneWayMission(shipId, destination, cargo)` - One-way delivery
- `launchRoundTripMission(shipId, destination, outbound, return)` - Fetch quest
- `processTransportMission(missionId, deltaMs)` - Tick transport missions
- `handleStorageOverflow(shipId)` - Manage full storage situations

### GalaxyGeneratorService (Procedural Generation)

**Role**: Star system generation, body creation, feature assignment.

**Key Methods**:
- `generateSystem(seed)` - Create random system
- `placeSystemInGalaxy(seed, frontier)` - Calculate coordinates
- `generateBodies(systemRarity)` - Create bodies with features

## Game Loop Flow

```
GameLoopService.tick(deltaMs)
  ├─ ProductionService.processProduction(deltaHours)
  │   └─ For each facility (sorted by tier):
  │       ├─ Check inputs available
  │       ├─ Consume inputs, produce outputs
  │       └─ Update storage
  │
  ├─ PopulationService.calculatePopulationGrowth(deltaHours)
  │   ├─ Calculate pull factors
  │   └─ Update population with growth formula
  │
  ├─ TradeService.processTradeRoutes(deltaHours)
  │   └─ Advance each ship on active route
  │
  ├─ SupplyTransportService.processTransportMission(deltaHours)
  │   └─ Advance each transport mission
  │
  └─ GameStateService saves periodically
```

## Data Storage Model

### Collections in GameState (All use Record<id, T>)

| Collection | Key Type | Value Type | Purpose |
|-----------|----------|-----------|---------|
| systems | string (systemId) | StarSystem | Star systems with discovery/colonization state |
| bodies | string (bodyId) | CelestialBody | Planets, moons, orbital structure |
| facilities | string (facilityId) | Facility | Built production buildings |
| ships | string (shipId) | Ship | Fleet units |
| tradeRoutes | string (routeId) | TradeRoute | Recurring trade configurations |
| scoutMissions | string (missionId) | ScoutMission | Active scout missions |
| transportMissions | string (missionId) | TransportMission | Active transport missions (new GDD v6) |
| tradeMissions | string (missionId) | TradeMission | One-time trade missions |
| marketPrices | ResourceId | { buy, sell } | Galactic market prices |
| notifications | (array) | Notification | Player notifications queue |

### Resource Storage (Per-System)

Resources are tracked at system level with shared storage pools:

```typescript
// Storage at system level
const systemStorage: Record<string, ResourceStock> = {
  [ResourceId.Steel]: { resourceId: ResourceId.Steel, amount: 500, capacity: 5000 },
  [ResourceId.Fuel]: { resourceId: ResourceId.Fuel, amount: 200, capacity: 5000 }
  // ...
}
```

## Key Game Systems

### 1. Resource System
- **Tier 1**: Raw (IronOre, Silicates, Ice, etc.)
- **Tier 2**: Refined (Steel, Glass, Fuel, etc.)
- **Tier 3**: Processed (StructuralMaterials, Polymers, etc.)
- **Tier 4**: Advanced (Components, Electronics, Weapons, etc.)
- **Tier 5**: High-Tech (QuantumMaterials, SyntheticMinds, etc.)
- **Special**: Credits (currency)

### 2. Facility System
- **Tier 1-5**: Production facilities organized by tier
- **Support**: Trade (Outpost/Station/Hub), Research, Security, Communications, Finance, Tourism
- **Temporary**: ColonyShip (during colonization)

### 3. Ship System
- **Sizes**: Light (fast), Medium, Heavy, Bulk (efficient)
- **Tiers**: Ships have quality levels affecting reliability
- **Status**: Idle, InTransit, conditions for breakdown/stranded

### 4. Population & SoL
- **Floor**: Minimum workers needed (sum of facility floors)
- **Ceiling**: Maximum inhabitants (facility ceilings × body type multiplier)
- **Growth**: Formula based on pull factors and capacity gap
- **Pull Factors**: Food quality, consumer goods, medical, security, etc.

### 5. Exploration & Colonization
- **Scout Missions**: Send scouts to frontier, receive survey data
- **Colonization**: Establish colony ship, deliver resources, convert to trade outpost
- **First Colony Protection**: First colonization guaranteed success

### 6. Trade & Transport
- **Trade Routes**: Recurring round-trip routes with just-in-time loading
- **One-Way Missions**: Permanent relocation with upfront reservation
- **Round-Trip Missions**: Fetch quests with return cargo
- **Galactic Market**: Instant buy/sell with 10-25% spread

## Testing Conventions

Values marked with `//TESTING` comment indicate they've been modified for easier iteration:

```typescript
// Example: In testing.config.ts
const SPAWN_INTERVAL = 5000; //TESTING - reduced from 60000 for faster iteration

// Find all testing values with: grep -r "//TESTING" src/
```

## Version Management

- **Current Version**: 0.2.0 (GDD v6 update with supply transport)
- **Previous Version**: 0.1.0 (GDD v5)
- **Migration Logic**: In GameStateService.migrateGameState() - triggers on version mismatch

## Code Style & Conventions

| Item | Convention |
|------|-----------|
| Indentation | 2 spaces |
| Quotes | Single quotes |
| Line Endings | LF |
| Component Selector | `app-*` prefix |
| Enums | PascalCase (e.g., `ResourceId`) |
| Enum Values | PascalCase (e.g., `ShipStatus.Idle`) |
| Private Signals | `_camelCase` (e.g., `_gameState`) |
| Public Computed | `readonly camelCase` (e.g., `credits`) |
| Constants | UPPER_SNAKE_CASE (e.g., `GAME_VERSION`) |
| Methods Return Types | Explicit type annotations required |
| Null Checks | Strict mode enabled - all checks required |

## Key Locations by Feature

| Feature | Primary Files |
|---------|-----------------|
| State Management | GameStateService, GameState model |
| Game Loop | GameLoopService, game-loop.service.spec.ts |
| Exploration | ExplorationService, exploration.service.spec.ts |
| Colonization | ColonizationService, colonization.service.spec.ts |
| Production | ProductionService, production.service.spec.ts |
| Population | PopulationService, population.service.spec.ts |
| Trade Routes | TradeService, trade.service.spec.ts |
| Transport Missions | SupplyTransportService (NEW), supply-transport.service.ts |
| Galaxy Gen | GalaxyGeneratorService, galaxy-generator.service.spec.ts |
| Construction | ConstructionService, construction.service.spec.ts |
| Ships | ShipType, ShipSize, ShipTier enums in ship.model.ts |
| Prestige | PrestigeService, prestige.service.spec.ts |

## Important Notes

### Chesterton's Fence Principle

Before removing any code:
1. Understand WHY it was written
2. Prefer tweaking over removing
3. Verify it's truly unneeded before deletion
4. Investigate if purpose is unclear

### YAGNI (You Aren't Gonna Need It)

- Don't build abstractions for hypothetical features
- Don't add "just in case" code
- Simple > Clever
- Only abstract when 3+ places duplicate code

### Save/Migration Pattern

When changing GameState schema:
1. Increment GAME_VERSION
2. Implement migration in GameStateService.migrateGameState()
3. Add new fields with sensible defaults
4. Notify player of migration

## Source Files Referenced

- `/src/app/models/` - All model files (resource, facility, celestial-body, star-system, ship, game-state, prestige, transport-mission)
- `/src/app/services/` - All service files (game-state, game-loop, exploration, colonization, construction, production, population, trade, supply-transport, galaxy-generator, prestige, stellar-forge)
- `/src/app/components/` - UI components (system-view, galaxy-view, fleet-view, market-view)
- `/src/app/config/testing.config.ts` - Testing constants
- `/IDLE_GDD.txt` - Game Design Document v6
- `/CLAUDE.md` - Project conventions and patterns
